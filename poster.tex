\documentclass{tikzposter}
\tikzposterlatexaffectionproofoff

% \settitle{\vbox{
%      \color{titlefgcolor} {\bfseries \Huge \sc \@title \par}
%      \vspace*{1em}
%      {\LARGE \@author \par} \vspace*{1em} {\large \@institute}
% }}

\makeatletter
\renewcommand\TP@maketitle{%
   \begin{minipage}{0.8\linewidth}
        \color{titlefgcolor}
        {\bfseries \Huge \sc \@title \par}
        \vspace*{1em}
        {\huge \@author \par}
        \vspace*{1em}
        {\LARGE \@institute}
    \end{minipage}
    \hfill
    \begin{minipage}{0.2\linewidth}
       \centering
       \begin{tikzpicture}[scale=0.07]
           \begin{scope}[y={(0,-1)}]
               \input{uoa.tex}
           \end{scope}
           \begin{scope}[y={(0,-1)},shift={(0.75,50)}]
               \input{awc.tex}
           \end{scope}
       \end{tikzpicture}
    \end{minipage}
}
\makeatother

\title{Efficient Bayesian Evolutionary Analysis using Hamiltonian Monte Carlo}
\author{\textbf{Arman Bilge}, Timothy Vaughan, and Alexei J. Drummond}
\institute{email: \texttt{armanbilge@gmail.com}}

\defineblockstyle{MySlide}{
    titlewidthscale=1, bodywidthscale=1, titleleft,
    titleoffsetx=0pt, titleoffsety=0pt, bodyoffsetx=0pt, bodyoffsety=0pt,
    bodyverticalshift=0pt, roundedcorners=0, linewidth=0pt, titleinnersep=1cm,
    bodyinnersep=1cm
}{
    \ifBlockHasTitle%
        \draw[draw=none, left color=blocktitlebgcolor, right color=blocktitlebgcolor]
           (blocktitle.south west) rectangle (blocktitle.north east);
    \fi%
    \draw[draw=none, fill=blockbodybgcolor] %
        (blockbody.north west) [rounded corners=30] -- (blockbody.south west) --
        (blockbody.south east) [rounded corners=0]-- (blockbody.north east) -- cycle;
}

\usetheme{Autumn}
\usecolorstyle{Russia}
\definecolor{uoanavy}{RGB}{0,60,127}
\colorlet{titlebgcolor}{uoanavy}
\colorlet{blocktitlebgcolor}{uoanavy}
\useblockstyle{MySlide}
\renewcommand{\familydefault}{\sfdefault}
\usepackage{sfmath}

\usepackage{enumitem}
\setlist[itemize]{label=$\triangleright$, labelsep=12pt}

% Plots
\usetikzlibrary{arrows.meta}
\usepackage{pgfplots}
\usepackage{pgfplotstable}
\usepgfplotslibrary{statistics}
\pgfplotsset{width=32cm,
             compat=newest,
             jitter/.style={
                 x filter/.code={\pgfmathparse{\pgfmathresult+rnd*#1}}
             },
             jitter/.default=0
             }

\makeatletter
\pgfarrowsdeclare{center*}{center*}
{
  \pgfarrowsleftextend{+-.5\pgflinewidth}
  \pgfutil@tempdima=0.4pt%
  \advance\pgfutil@tempdima by.2\pgflinewidth%
  \pgfarrowsrightextend{4.5\pgfutil@tempdima}
}
{
  \pgfutil@tempdima=0.4pt%
  \advance\pgfutil@tempdima by.2\pgflinewidth%
  \pgfsetdash{}{+0pt}
  \pgfpathcircle{\pgfqpoint{4.5\pgfutil@tempdima}{0bp}}{4.5\pgfutil@tempdima}
  \pgfusepathqfillstroke
}
\makeatother

\usepackage{mathtools}
\newcommand{\dd}{\, \mathrm{d}}
\renewcommand{\vec}[1]{\ensuremath{\boldsymbol{\mathbf{#1}}}}
\newcommand{\mat}[1]{\ensuremath{\boldsymbol{\mathbf{#1}}}}
\newcommand{\op}[1]{\ensuremath{\boldsymbol{\mathbf{#1}}}}
\newcommand{\norm}[1]{\ensuremath{\mathcal{N}\left(#1\right)}}

\usepackage{algorithm}
\usepackage{algpseudocode}
\algrenewcomment[2][.4\linewidth]{\leavevmode\hfill\makebox[#1][l]{\(\triangleright\)~#2}}

\frenchspacing

\begin{document}

    \maketitle

    \begin{columns}

        \column{0.5}

        \block{Motivation}{
            \flushleft
            \begin{itemize}
                \item Bayesian evolutionary analysis is a powerful tool for rate estimation, divergence dating, phylogeography, species tree inference, etc.
                \item Usually implemented with the Markov chain Monte Carlo algorithm (MCMC)
                \item MCMC has poor performance
                \item Hamiltonian Monte Carlo (HMC)
            \end{itemize}
        }

        \block{Hamiltonian Dynamics}{

            Imagine a particle of mass $\mat{M}$  with position $\vec{q}$ and momentum $\vec{p}$.

            Let $\pi\left(\vec{q}\right) \equiv P\left(\vec{\theta}\mid\vec{D}\right)$ be the target probability density.

            Then the Hamiltonian for our system is
            \begin{equation*}
                \mathcal{H}\left(\vec{q},\vec{p}\right) = U\left(\vec{q}\right) + K\left(\vec{p}\right)
            \end{equation*}
            with potential energy
            \begin{equation*}
                U\left(\vec{q}\right) = -\log{\pi\left(\vec{q}\right)}
            \end{equation*}
            and kinetic energy
            \begin{equation*}
                K\left(\vec{p}\right) = \frac{1}{2} \vec{p}^T \mat{M} \vec{p}.
            \end{equation*}

            The system's dynamics are described by Hamilton's equations
            \begin{align*}
                \frac{\dd \vec{q}}{\dd t} &= \frac{\partial \mathcal{H}}{\partial \vec{p}}, \\
                \frac{\dd \vec{p}}{\dd t} &= -\frac{\partial \mathcal{H}}{\partial \vec{q}},
            \end{align*}
            which are integrated to find the particle's position and momentum at a particular time.
        }

        \block{The HMC Algorithm}{

            The three operators.

            \begin{algorithmic}[1]
            \Function {HamiltonUpdate}{$\left\{\vec{q},\vec{p}\right\}$}
                \State $\left\{\vec{q}^\prime, \vec{p}^\prime\right\} \leftarrow \op{F}\op{L}\op{R}\left\{\vec{q},\vec{p}\right\}$ \Comment{Make proposal}
                \State $a \leftarrow \min\left(1, \exp\left(\mathcal{H}\left(\vec{q}, \vec{p}\right) - \mathcal{H}\left(\vec{q}^\prime, \vec{p}^\prime\right)\right)\right)$ \Comment{Calculate acceptance probability}
                \State $\left\{\vec{q},\vec{p}\right\} \leftarrow
                    \begin{cases}
                        \left\{\vec{q}^\prime, \vec{p}^\prime\right\} & \text{with probability } a \\
                        \left\{\vec{q},\vec{p}\right\} & \text{with probability } 1 - a
                    \end{cases}$
                    \Comment{Accept or reject proposal}
                \State $\left\{\vec{q},\vec{p}\right\} \leftarrow \op{F}\left\{\vec{q},\vec{p}\right\}$ \Comment{Flip momentum}
                \State \Return $\left\{\vec{q},\vec{p}\right\}$
            \EndFunction
            \end{algorithmic}

            \innerblock{Flip Operator}{
                Flips the particle's momentum.
                \begin{equation*}
                    \op{F}\left\{\vec{q},\vec{p}\right\} = \left\{\vec{q},-\vec{p}\right\}
                \end{equation*}
                \centering
                \begin{tikzpicture}[scale=1.5]
                    \draw [very thick] (-3,0) -- (3,0);
                    \draw [very thick] (0,-3) -- (0,3);
                    \draw [arrows={center*-Latex[scale=1]}, line width=1.5mm] (-2,-1) -- (-1,-0.125);

                    \draw[-{Triangle[scale=0.5]}, line width=1cm] (3.75,0) -- (5.5,0);
                    \node at (4.5,1) {$\op F$};

                    \begin{scope}[shift={(9.25,0)}]
                        \draw [very thick] (-3,0) -- (3,0);
                        \draw [very thick] (0,-3) -- (0,3);
                        \draw [arrows={center*-Latex[scale=1]}, line width=1.5mm] (-2,-1) -- (-3,-1.875);
                    \end{scope}
                \end{tikzpicture}
                \begin{tikzpicture}[scale=1.5]
                \end{tikzpicture}
            }

            \vspace{-100pt}

            \innerblock{Leapfrog Operator}{
                Simulates the motion of the particle for some time $s$.
                \begin{equation*}
                    \op{L}\left\{\vec{q}^t,\vec{p}^t\right\} = \left\{\vec{q}^{t+s},\vec{p}^{t+s}\right\}
                \end{equation*}
                \centering
                \begin{tikzpicture}[scale=1.5]
                    \draw [very thick] (-3,0) -- (3,0);
                    \draw [very thick] (0,-3) -- (0,3);
                    \draw [arrows={center*-Latex[scale=1]}, line width=1.5mm] (-2,-1) -- (-1,-0.125);

                    \draw[-{Triangle[scale=0.5]}, line width=1cm] (3.75,0) -- (5.5,0);
                    \node at (4.5,1) {$\op L$};

                    \begin{scope}[shift={(9.25,0)}]
                    \draw [very thick] (-3,0) -- (3,0);
                    \draw [very thick] (0,-3) -- (0,3);
                    \draw [arrows={center*-Latex[scale=1]}, line width=1.5mm] (1.5,2) -- (1,1);
                    \draw [dashed, line width=1.5mm] (-2, -1) -- (-1.5, -0.5) -- (-0.75, 0) -- (0.5, 0.25) -- (2, -0.25) -- (2.75, 0.25) -- (3, 1) -- (2.75, 1.75) -- (2.25, 2.25) -- (1.5,2);
                    \end{scope}
                \end{tikzpicture}
            }

            \vspace{-135pt}

            \innerblock{Momentum Randomization Operator}{
                Randomizes the particle's momentum.
                \begin{equation*}
                    \op{R}\left\{\vec{q},\vec{p}\right\} = \left\{\vec{q}, \sqrt{1-\alpha}\vec{p} + \sqrt{\alpha}\vec{n}\right\},
                    \vec{n} \sim \norm{\vec{0}, \mat{M}^{-1}},
                \end{equation*}
                \centering
                \begin{tikzpicture}[scale=1.5]
                    \draw [very thick] (-3,0) -- (3,0);
                    \draw [very thick] (0,-3) -- (0,3);
                    \draw [arrows={center*-Latex[scale=1]}, line width=1.5mm] (-2,-1) -- (-1,-0.125);

                    \draw[-{Triangle[scale=0.5]}, line width=1cm] (3.75,0) -- (5.5,0);
                    \node at (4.5,1) {$\op R$};

                    \begin{scope}[shift={(9.25,0)}]
                        \draw [very thick] (-3,0) -- (3,0);
                        \draw [very thick] (0,-3) -- (0,3);
                        \begin{scope}[transparency group, opacity=0.5]
                            \draw [arrows={center*-Latex[scale=1]}, line width=1.5mm] (-2,-1) -- (-2.1798842696593654,-1.4155589244095708);
                        \end{scope}
                        \begin{scope}[transparency group, opacity=0.5]
                            \draw [arrows={center*-Latex[scale=1]}, line width=1.5mm] (-2,-1) -- (-0.6008855294301123,-0.6325503943607074);
                        \end{scope}
                        \begin{scope}[transparency group, opacity=0.5]
                            \draw [arrows={center*-Latex[scale=1]}, line width=1.5mm] (-2,-1) -- (-0.433635757898837,-2.110341758060427);
                        \end{scope}
                        \begin{scope}[transparency group, opacity=0.5]
                            \draw [arrows={center*-Latex[scale=1]}, line width=1.5mm] (-2,-1) -- (0.1203974434179913,-0.291105605921284);
                        \end{scope}
                        \begin{scope}[transparency group, opacity=0.5]
                            \draw [arrows={center*-Latex[scale=1]}, line width=1.5mm] (-2,-1) -- (-1.747006309898812,0.14720266924040804);
                        \end{scope}
                        \begin{scope}[transparency group, opacity=0.5]
                            \draw [arrows={center*-Latex[scale=1]}, line width=1.5mm] (-2,-1) -- (-2.15927910124528,-1.2791810510482209);
                        \end{scope}
                        \begin{scope}[transparency group, opacity=0.5]
                            \draw [arrows={center*-Latex[scale=1]}, line width=1.5mm] (-2,-1) -- (-2.061932819568363,0.9037350636252279);
                        \end{scope}
                        \begin{scope}[transparency group, opacity=0.5]
                            \draw [arrows={center*-Latex[scale=1]}, line width=1.5mm] (-2,-1) -- (-2.526733010065044,0.30727194147897574);
                        \end{scope}
                        \begin{scope}[transparency group, opacity=0.5]
                            \draw [arrows={center*-Latex[scale=1]}, line width=1.5mm] (-2,-1) -- (-1.692667393072648,-1.5883973996582634);
                        \end{scope}
                        \begin{scope}[transparency group, opacity=0.5]
                            \draw [arrows={center*-Latex[scale=1]}, line width=1.5mm] (-2,-1) -- (-1.3925483516600632,-2.1358524884658907);
                        \end{scope}
                    \end{scope}
                \end{tikzpicture}
            }
        }

        \column{0.5}

        \block{HMC versus MCMC}{

            \centering
                \begin{tikzpicture}
                    % Tree
                    \begin{scope}[shift={(2.5,18)}]
                        \draw [line width=1mm] (0,0) -- (0,2);
                        \draw [line width=1mm] (3,0) -- (3,2);
                        \draw [line width=1mm] (0,2) -- (3,2);
                        \draw [line width=1mm] (1.5,2) -- (1.5,4);
                        \draw [line width=1mm] (6,0) -- (6,4);
                        \draw [line width=1mm] (1.5,4) -- (6,4);
                        \draw [line width=1mm] (3.75,4) -- (3.75,5);
                        \draw [ultra thick, dashed] (0,0) -- (7.5,0);
                        \draw [ultra thick, dashed] (0,2) -- (7.5,2);
                        \draw [ultra thick, dashed] (0,4) -- (7.5,4);
                        \node at (7.5,1) {$t_2$};
                        \node at (7.5,3) {$t_1$};
                    \end{scope}

                    % Legend
                    \begin{scope}[shift={(16,22)}]
                        \draw [line width=1mm, red] (0,1) -- (1,1);
                        \draw [line width=1mm, violet] (0,0) -- (1,0);
                        \node [text=red, right] at (1.125,1) {\textbf{HMC}};
                        \node [text=violet, right] at (1.125,0) {\textbf{MCMC}};
                    \end{scope}

                    \begin{axis}[colormap/greenyellow,
                                 mesh/interior colormap={graygray}{color=(gray) color=(gray)},
                                 /pgf/number format/1000 sep={},
                                 view={72}{32},
                                 xlabel=$t_1$,
                                 ylabel=$t_2$,
                                 zlabel=$U\left(\vec{q}\right)$,
                                 zlabel style={rotate=-90},
                                 xtick={0,0.2,...,2},
                                 ytick={0,0.2,...,1},
                                 ztick={1000,1020,...,1200}
                                 ]
                        \addplot3[surf] table {surface.dat};
                        \addplot3[violet, mark=*, line width=1mm] table {mcmc.dat};
                        \addplot3[red, mark=square*, line width=1mm] table {hmc.dat};
                    \end{axis}
                \end{tikzpicture}
        }

        \block{Performance}{

            \begin{tikzpicture}
                \begin{semilogxaxis}[width=16cm,
                                     xtick={8,16,32,64},
                                     ytick={0,4,...,20},
                                     extra y ticks=1,
                                     extra y tick labels=,
                                     extra y tick style={ grid=major, major grid style={thick} },
                             % x tick label style={/pgf/number format/1000}
                             ]
                    \addplot+[uoanavy, only marks,jitter=0.25] table {performance.dat};
                    % \draw ({rel axis cs:0,0} |- {axis cs:Fx,1}) -- ({axis cs:Fz,1} -| {rel axis cs:1,0});
                    % \addplot table[y={create col/linear regression={y=y}}] {performance.dat};
                    \draw (axis cs:\pgfkeysvalueof{/pgfplots/xmin},1) -- (axis cs:\pgfkeysvalueof{/pgfplots/xmax},1);
                    % \addplot+[boxplot] table {performance.dat};
                \end{semilogxaxis}
            \end{tikzpicture}

        }

        \block{Future Directions}{
            \begin{itemize}
                \item Automatic tuning of parameters
            \end{itemize}
        }

        \block{Acknowledgements}{
            \flushleft
            \begin{itemize}
                \item New Zealand eScience Infrastructure
                \item SMBE Undergraduate Travel Award
            \end{itemize}
        }

        \block{References}{
            \flushleft\small
            \hangindent=50pt Drummond et al. `Bayesian phylogenetics with BEAUti and the BEAST 1.7'. \emph{Mol Biol Evol} 29.8 (2012).

            \hangindent=50pt Duane et al. `Hybrid Monte Carlo'. \emph{Physics Letters B} 195.2 (1987).

            \hangindent=50pt Metropolis et al. `Equation of State Calculations by Fast Computing Machines'. \emph{J Chem Phys} 21.6 (1953).

            \hangindent=50pt Neal. `MCMC Using Hamiltonian Dynamics'. \emph{Handbook of Markov Chain Monte Carlo}. Boca Raton, Florida: Chapman and Hall/CRC, 2011.

            \hangindent=50pt Schadt et al. `Computational Advances in Maximum Likelihood Methods for Molecular Phylogeny'. \emph{Genome Research} 8.3 (1998).
        }

    \end{columns}

\end{document}